node('jenkins-slave') {

    git_info = checkout scm

    // sh "echo ${git_info.GIT_COMMIT}"

    sh "git rev-parse --short HEAD > commit-id"
    tag = readFile('commit-id').replace("\n", "").replace("\r", "")

    stage('Build') {
        sh (script: """
        echo \"Fetching...\"
        cd ./ci-cd/sample-app/

        echo "Building..."
        docker build . -t vking34/sample-app:${tag}
        """)

        docker.withRegistry("", "dockerhub"){
            sh "docker push vking34/sample-app:${tag}"
        }
    }
    
    stage('Test') {
        sh(script: """
        echo "Done!"
        """)
    }

    stage('Delivery to Staging'){
        withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh(script: """
            cd ../
            git clone https://github.com/vking34/sample-app-deployments.git
            cd ./sample-app-deployments
            git config --global user.name "vking34"
            git config --global user.email "lzzvkingzzl@gmail.com"
            sed -i -z -E "s/sample-app:[^\\n]+\\n/sample-app:${tag}\\n/g" staging/deployments/deployment.yaml
            git add .
            git commit -m \"fix(staging): Delivery to staging env with commit ${tag}\"
            git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/vking34/sample-app-deployments.git
            """)
        }
    }

    stage('Deploy to Prod'){
        input message:'Approve deployment?'
        withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh(script: """
            cd ../sample-app-deployments
            pwd
            ls -la
            git config --global user.name "vking34"
            git config --global user.email "lzzvkingzzl@gmail.com"
            sed -i -z -E "s/sample-app:[^\\n]+\\n/sample-app:${tag}\\n/g" prod/deployments/deployment.yaml
            git add .
            git commit -m \"fix(prod): Delivery to staging env with commit ${tag}\"
            git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/vking34/sample-app-deployments.git
            """)
        }
    }
}