node('jenkins-slave') {

    git_info = checkout scm

    // sh "echo ${git_info.GIT_COMMIT}"

    sh "git rev-parse --short HEAD > commit-id"
    tag = readFile('commit-id').replace("\n", "").replace("\r", "")

    stage('Build') {
        sh (script: """
        echo \"Fetching...\"
        cd ./ci-cd/sample-app/

        echo "Building..."
        docker build . -t vking34/sample-app:${tag}
        """)

        docker.withRegistry("", "dockerhub"){
            sh "docker push vking34/sample-app:${tag}"
        }
    }
    
    stage('Test') {
        sh(script: """
        echo "Done!"
        """)
    }

    stage('Delivery'){
        sh(script: """
        cd ../
        git clone https://github.com/vking34/sample-app-deployments.git
        cd ./sample-app-deployments
        pwd
        sed -i -z -E "s/sample-app:[^\\n]+\\n/sample-app:944805b\\n/g" staging/deployments/deployment.yaml
        git add .
        git commit -m \"Delivery to staging env with commit ${tag}\"
        """)

        withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh('git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/vking34/sample-app-deployments.git')
        }
    }
}

// pipeline {
//     agent { label 'jenkins-slave'}
//     stages {
        

//         stage('Build') {
//             steps {
//                 sh (script: """
//                     echo "Building..."
//                     """)
//             }
//         }

//         stage('Test') {
//             steps {
//                 sh(script: """
//                 echo "Done!"
//                 """)
//             }
//         }
//     }
// }


// node('jenkins-slave') {

//     checkout scm

//     env.DOCKER_API_VERSION="1.23"
    
//     sh "git rev-parse --short HEAD > commit-id"

//     tag = readFile('commit-id').replace("\n", "").replace("\r", "")


//     stage('Build') {
//         sh (script: """
//         echo "Fetching..."
//         git clone https://github.com/vking34/devops-references.git
//         cd ./devops-references/ci-cd/sample-app/

//         echo "Building..."
//         docker build . -t vking34/sample-app:${tag}
//         """)
//     }
    
//     stage('Test') {
//         sh(script: """
//         echo "Done!"
//         """)
//     }

//     stage('Delivery'){

//     }
// }